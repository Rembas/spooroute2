{% extends "base.html" %}
{% block content %}
<div class="row g-4">
  <div class="col-12 col-lg-5">
    <div class="card p-3">
      <h5 class="mb-3" data-i18n="live">Live status</h5>
      <ul class="list-group list-group-flush">
        {% for line in status.lines %}
          <li class="list-group-item d-flex align-items-center justify-content-between">
            <div><strong>Route {{ line.route_id }}</strong></div>
            {% if line.status == "on_time" %}
              <span class="badge on-time">On time</span>
            {% elif line.status == "delayed" %}
              <span class="badge delayed">Delayed ({{ line.delay_min }}’)</span>
            {% else %}
              <span class="badge alert">Alert</span>
            {% endif %}
          </li>
        {% else %}
          <li class="list-group-item text-muted">No data (demo)</li>
        {% endfor %}
      </ul>
      <div class="mt-3 d-flex gap-2">
        <a class="button-primary btn" href="/alternatives?from_stop=STOP_A">Show alternatives</a>
        <a class="btn btn-outline-secondary" href="/admin">Admin</a>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-7">
    <div class="card p-3">
      <h5 class="mb-3" data-i18n="map">Map</h5>
      <div id="map"></div>
      <div class="small text-muted mt-2">Click a marker to open alternatives for that stop.</div>
    </div>
  </div>
  <div class="alert alert-info d-flex align-items-center gap-2" role="alert">
  <strong class="me-2">Bulletins</strong>
  <div class="flex-grow-1">
    {% for b in bulletins.bulletins %}
      <span class="me-3">[{{ b.severity|upper }}] {{ b.title }}</span>
    {% else %}
      <span class="text-muted">No bulletins</span>
    {% endfor %}
  </div>
</div>
<div id="crowd" class="small text-muted mt-2"></div>
<script>
  fetch("/_demo/crowd_count").then(r=>r.json()).then(d=>{
    const entries = Object.entries(d.counts || {}).filter(([k,v])=>v>=3);
    if(entries.length){
      document.getElementById('crowd').innerHTML =
        '⚠ Crowd signal near: ' + entries.map(([k,v])=> `${k} (${v})`).join(', ');
    }
  }).catch(()=>{});
</script>

</div>
{% endblock %}
<script>
  (function(){
    const bind = JSON.parse(localStorage.getItem('spoko_binding')||'null');
    if (!bind || !bind.line) return;
    document.querySelectorAll('.list-group-item').forEach(li=>{
      const txt = li.innerText || '';
      if (!txt.includes('Route ' + bind.line)) li.style.opacity = .35;
    });
  })();
</script>
